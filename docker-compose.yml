services:
  postgres:
    image: postgres:16-alpine
    container_name: qsolog-postgres
    environment:
      POSTGRES_DB: qsolog
      POSTGRES_USER: qsolog
      POSTGRES_PASSWORD: qsolog
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qsolog"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - qsolog-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: qsolog-backend
    ports:
      - "8081:8080"
    environment:
      SERVER_PORT: 8080
      DB_URL: r2dbc:postgresql://postgres:5432/qsolog
      DB_URL_JDBC: jdbc:postgresql://postgres:5432/qsolog
      DB_USER: qsolog
      DB_PASS: qsolog
      JWT_SECRET: CHANGE_THIS_SECRET_IN_PRODUCTION_MIN_256_BITS_LONG_KEY_FOR_HS512
      FLYWAY_ENABLED: "true"
      # If you run Angular via `ng serve` (default :4200), include it here.
      CORS_ORIGINS: http://localhost,http://localhost:80,http://localhost:4200,http://127.0.0.1:4200
      # Admin bootstrap (creates admin user on first startup)
      ADMIN_BOOTSTRAP: "true"
      ADMIN_EMAIL: admin@qsolog.local
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: Admin123!
      # Optional: Add HamQTH credentials
      # HAMQTH_USERNAME: your_username
      # HAMQTH_PASSWORD: your_password
      # Optional: Add OpenAI API key
      # OPENAI_API_KEY: sk-...
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s
    networks:
      - qsolog-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: qsolog-frontend
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - qsolog-network

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: qsolog-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@qsolog.local
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres
    profiles:
      - tools
    networks:
      - qsolog-network

networks:
  qsolog-network:
    driver: bridge

volumes:
  postgres_data:
    name: qsolog_postgres_data
